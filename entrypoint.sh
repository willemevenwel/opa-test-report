#!/bin/sh
# Entrypoint for dual-mode: webserver or static render
set -e

echo "Welcome to Polly Rego Policy Coverage Report utility!"
echo 
echo "::::::::::::::::::::::::::::------::.+#+=:::::::::::::::::::::::::::::"
echo "::::::::::::::::::::::::-+*********+=:*##*::::::::::::::::::::::::::::"
echo "::::------------------=*#**************#*#=:-====-::::::::::::::::::::"
echo ":::++++++++++++++++++*#***************##*##*********=:::::::::::::::::"
echo "::-*+++++++++==++++=*#*##***************************#*-.::::::::::::::"
echo "::-*+++++++=--=+++++####***************#**************#-::::::::::::::"
echo "::-*++=-++=:-=++++++*+#****************#***************#+-::::=+::::::"
echo "::-*++=:---=++++++++++#**********#*====#*******************++**#=:::::"
echo "::-*++++--++++++++++++##**********-=====*******##**************#+:::::"
echo "::-*++++++++=-=+++++*#**#*******##====+++**+++=*#*************#+::::::"
echo "::-*++==++=--=++++++#*#*+++++++++===========---+#*************#+::::::"
echo "::-*++=:--:=+++++++*#*#***+=-===-====*******+===****************#-::::"
echo "::-*+++=--=+++++++++%#+==+*#+======**+++++=+**=-=*#***************::::"
echo "::-*++++++++=-=++++#**=+=-=*#*====#*++=---++=*#==-=*##***********#-:::"
echo "::-*++==+++-:-++++*#*#+-...-*#==-**++:.::::=*=#+===+#************#::::"
echo "::-*++=:==:-=+++++##*#*:-++-+#*++#+*::+*+-::*=*#***##***********#+::::"
echo "::-*+++=::=+++++++#*=#*:*%%*+%***#*+:+%%%*::*=#*===#**********##=:::::"
echo "::-*++++=++++==++++#**+=*%#*+++++##*:*%#%*:+++#==+##*********#=:::::::"
echo "::-*+++++++=--=+++=*#+=+**==---===*#+=*#*==++#+===++##******#=..::::::"
echo "::-*++=-==--=++++++*=+***======+=-=+#**++****======-*#*****#-.:-::::::"
echo "::-*+++-::-++++++++*-==#=-=========-+#***++=========#******#==*#::::::"
echo "::-*++++==+++++++++#+-=#=-==========#*=++-=========+#*********#+::::::"
echo ":::+++++++++++++++++#+=+*=-+***#####%+-*+-======-=*#****##****+:::::::"
echo "::::--------====-----=+++*+*=*+%#**#*-=*========*##**##*##+--:::::::::"
echo "::::::::::-*****+-:::::-=+*+=+*+***+=+*=====++*##*%#*##+==::::::::::::"
echo ":::::::::-#*******:::::::::-==+*++++*+===++#+:-=+++---::::::::::::::::"
echo "::::::::.-#*****##+=::::::::..-#===========**-:..:::::::::::::=+**-:::"
echo "::::::::=*****#*+++**:::::::-+#+-========++****+=:::::::::::=**++*+:::"
echo ":::::::=#+++++#+++*+#-.:::-+*#*+======++++**++++**=:::::::-**++++#-:::"
echo ":::::::-#*****#****+#+==+**+#*++++++++++++#+++++++*+:::::=*+++++#=::::"
echo ":::::::=#+++++*#*#+++++*+++**+++++++++++++#++++++++**-::=#+++++#++++::"
echo ":::::::=#++***#**##**++++++#++++++++++++++#++++++++++*--#+++++##*++#::"
echo "::::::::-**+*##******#*+++**++++++++++++++*#*****+++++*#++++*#*+++#=::"
echo "::::::::::-*#*********#++*#*++++++++++*****+++++++++++*#+++**++++*=:::"
echo ":::::::::::+**********#*+==#++++++++***++++++++++++++++#*+**+++**-::::"
echo ":::::::::::=#***#####**=---**+++++***+***++++++++++++++**++++**=::::::"
echo ":::::::::::-+*#*+++==------=***++**+**++***++++++++++***+++**+-::--:::"
echo "===========+++============-:::-+*#+#*+*#*+++***++++*##*++**+=========="
echo "=========++=-==++=-----:--=+-::.=#**+*#+++*#*****+++++**+============="
echo "======+++-::=+-+++=++++=====+:-==-=**#****++==---::::-+#+++++++++====="
echo "====+*+-:::::+=:::------==+=+==-::::--==-::::::::::-==-+*+============"
echo "====#========-====-------=+*=-:::::::::::::::::::-==-=-=#**+=========="
echo "===*#===----======-------==-:::::::::::::::::::-==--=-=+*#*+=========="
echo "==+###****++==---==-:.:==-:::::::::::::::::::-==-=--=**#*+============"
echo "====++****###**++==++=*+=======---:::::::::-==-==-=**#*+=============="
echo "==========+++**#####%%*+===---=======-:::-==-=--=**#*+================"
echo "================+**######***++==----====+=-==-=*##*+=================="
echo "==================+++++++***###**++==--=+--==*##*+===================="
echo "===========================+++***###**+=+==*##*+======================"
echo "=================================++***###*##*+========================"
echo "======================================++***+=========================="
echo "Created by @willemevenwel on GitHub"

echo 
echo "Opening in $1 mode..."
echo 

if [ "$1" = "bash" ]; then

  echo "ℹ️  - Opening interactive bash shell..."
  exec bash

else

  echo "ℹ️  - Executing policy unit test report"
  if opa test policies/ tests/ test_data/ --verbose > verbose.txt; then
    echo "✅ - Unit test report data generated."
  else
    echo "⚠️  - Unit test report generation failed, but continuing..."
  fi

  echo "ℹ️  - Executing policy coverage report"
  if opa test policies/ tests/ test_data/ --coverage > coverage.json; then
    echo "✅ - Coverage report data generated."
  else
    echo "⚠️  - Coverage report generation failed, but continuing..."
  fi

  if [ "$1" = "web" ]; then

    echo "ℹ️  - Starting Express webserver on port 3000..."
    exec node server.js
    echo "✅ - Node running."
  else
    echo "ℹ️  - Running static render..."
    exec sh render_and_exit.sh "$@"
    echo "✅ - Static render has run."
  fi
  
fi
 